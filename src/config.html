<script type="text/javascript">
var updateConfig = function(caller){

	var configVars = {
						'host' : $('#host').val(),
					  'port' : $('#port').val(),
					  'open_browser' : testCheckBox('#open_browser'),
					  'audio_format' : $('#audio_format').val(),
					  'pen_language' : $('#pen_language').val(),
					  'library_path' : $('#library_path').val(),
					  'log_level' : $('#log_level').val()
					  };
	$.post('/config',
		   'action=update&data=' + encodeURIComponent(JSON.stringify(configVars)))
		   .done( function(data,textStatus,jqXHR) {
			   if ( data.success ) {
				   notify($( '#submit' ),'',"OK",'bg-success',1000);
		       } else {
		    	   notify($( '#submit' ),'',jqXHR.statusText,'bg-danger',4000);
		       }
		   })
		   .fail( function(data) {
			   notify($( '#submit' ),'','Connection Error','bg-danger',4000);
		   });
}

var fillInElement = function($id, data) {
    for ( var i in data) {
		if (data[i] === 'TRUE' || data[i] === 'FALSE') {
			if (data[i] === 'TRUE') {
				$('#' + i).prop('checked', true);
			} else {
				$('#' + i).prop('checked', false);
			}
		} else {
		    $('#' + i).val(data[i]);
		}
    }
}

var loadConfig = function(){

	$.post('/config', 'action=load')
		   .done( function(data,textStatus,jqXHR) {
			   if ( data.success ) {
			       fillInElement('', data.config);
			       document.getElementById('submit').disabled = false;
		       } else {
		    	   notify($( '#submit' ),'',jqXHR.statusText,'bg-danger',4000);
		    	   document.getElementById('submit').disabled = true;
		       }
		   })
		   .fail( function(data) {
			   notify($( '#submit' ),'','Connection Error','bg-danger',4000);
			   document.getElementById('submit').disabled = true;
		   });
}

var downloadOidImages = function(){
	window.location.href = '/download_oid_images';
}

var loadLogs = function(){
	$.get('/logs?lines=100')
		.done(function(data) {
			if (data.success) {
				var logsText = data.logs.join('\n');
				$('#log-display').text(logsText);
				// Auto-scroll to bottom
				var logDisplay = document.getElementById('log-display');
				logDisplay.scrollTop = logDisplay.scrollHeight;
			}
		})
		.fail(function() {
			$('#log-display').text('Failed to load logs');
		});
}

var changeLogLevel = function(){
	var level = $('#log_level').val();
	$.ajax({
		url: '/logs/level',
		type: 'POST',
		contentType: 'application/json',
		data: JSON.stringify({level: level})
	})
	.done(function(data) {
		if (data.success) {
			notify($('#log_level'), '', 'Log level changed to ' + level, 'bg-success', 2000);
			// Refresh logs after a short delay to show the change
			setTimeout(loadLogs, 500);
		}
	})
	.fail(function() {
		notify($('#log_level'), '', 'Failed to change log level', 'bg-danger', 4000);
	});
}

// Auto-refresh logs every 3 seconds
var logRefreshInterval;

$(function(){
    loadConfig();
	$('[data-toggle="tooltip"]').tooltip();
	$('#submit').click(function(){
		updateConfig( $(this) );
	});
	$('#download-oid-images').click(function(){
		downloadOidImages();
	});
	$('#log_level').change(function(){
		changeLogLevel();
	});
	$('#refresh-logs').click(function(){
		loadLogs();
	});

	// Initial log load
	loadLogs();

	// Auto-refresh logs every 3 seconds
	logRefreshInterval = setInterval(loadLogs, 3000);
});

</script>
<div class="panel panel-default">
	<div class="panel-heading">
		<h4 class="panel-title">ttmp32gme configuration:</h4>
	</div>
	<div class="panel-body">
		<div class="form-group">
			<label for="host">ttmp32gme http server host:</label> <input type="text" id="host"
				class="form-control" value="127.0.0.1" data-toggle="tooltip"
				title="The TCP address which the HTTP server will listen on. By default it only listens to requests from the same machine (safe). Set this to 0.0.0.0, for a public server (only recommended if you are in a trusted network behind a firewall). Requires restart to take effect.">
		</div>
		<div class="form-group">
			<label for="port">ttmp32gme http server port:</label> <input type="text" id="port"
				class="form-control" value="10020" data-toggle="tooltip"
				title="If you modify this, you will need to restart ttmp32gme.">
		</div>
		<div class="checkbox">
			<label> <input type="checkbox" id="open_browser" checked>
				Open ttmp32gme web interface in default browser on startup.
			</label>
		</div>
		<div class="form-group">
			<label for="port">audio format:</label>
			<select type="text" id="audio_format"
				class="custom-select form-control" data-toggle="tooltip"
				title="Set this either to mp3 (high quality for headphones, large files) or ogg (low quality for speaker, small files).">
				<option value="mp3">mp3</option>
				<option value="ogg">ogg</option>
			</select>
		</div>
		<div class="form-group">
			<label for="library_path">ttmp32gme library path:</label> <input type="text" id="library_path"
				class="form-control" value="" data-toggle="tooltip"
				title="The path where the library of GME and mp3 files is stored">
		</div>
		<div class="form-group">
			<label for="port">TipToi pen language:</label>
			<select id="pen_language" class="custom-select form-control" data-toggle="tooltip"
				title="Choose the language of your TipToi Pen.">
				<option value="GERMAN">GERMAN</option>
				<option value="ENGLISH">ENGLISH</option>
				<option value="FRENCH">FRENCH</option>
				<option value="ITALIAN">ITALIAN</option>
			</select>
		</div>
		<div class="form-group">
			<label for="log_level">Log Level:</label>
			<select id="log_level" class="custom-select form-control" data-toggle="tooltip"
				title="Set the logging level for the application. Changes take effect immediately.">
				<option value="DEBUG">DEBUG</option>
				<option value="INFO">INFO</option>
				<option value="WARNING">WARNING</option>
				<option value="ERROR">ERROR</option>
				<option value="CRITICAL">CRITICAL</option>
			</select>
		</div>
		<button type="button" id="submit" class="btn btn-primary" data-toggle="popover" disabled>Save
			Configuration</button>
	</div>
</div>
<div class="panel panel-default">
	<div class="panel-heading">
		<h4 class="panel-title">Download OID Images:</h4>
	</div>
	<div class="panel-body">
		<p>Download all generated OID images as a ZIP file. These images can be used for designing and printing custom control sheets.</p>
		<button type="button" id="download-oid-images" class="btn btn-info" data-toggle="tooltip"
			title="Download all OID images as a ZIP file">
			<span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span> Download OID Images
		</button>
	</div>
</div>
<div class="panel panel-default">
	<div class="panel-heading">
		<h4 class="panel-title">Server Logs:</h4>
	</div>
	<div class="panel-body">
		<p>View recent server logs. Logs are automatically refreshed every 3 seconds. Change the log level above to control verbosity.</p>
		<button type="button" id="refresh-logs" class="btn btn-info btn-sm" data-toggle="tooltip"
			title="Manually refresh the log display">
			<span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> Refresh Now
		</button>
		<div style="margin-top: 10px;">
			<textarea id="log-display" class="form-control" readonly
				style="font-family: monospace; font-size: 12px; height: 400px; overflow-y: scroll; background-color: #f5f5f5; color: #333;">
Loading logs...
			</textarea>
		</div>
	</div>
</div>
