name: End-to-End Tests

# This workflow requires manual approval to run
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running E2E tests'
        required: false
        default: 'Manual E2E test run'
  pull_request:
    types: [labeled]
    
# Only run when 'run-e2e-tests' label is added or workflow is manually dispatched
jobs:
  check-label:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.result }}
    steps:
      - id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.label.name }}" == "run-e2e-tests" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  e2e-tests:
    name: End-to-End Tests with Selenium
    runs-on: ubuntu-latest
    needs: check-label
    if: needs.check-label.outputs.should-run == 'true'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for setuptools-scm
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
    
    - name: Install Chrome
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install ChromeDriver
      run: |
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d '.' -f 1)
        DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
        wget -q "https://chromedriver.storage.googleapis.com/${DRIVER_VERSION}/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
    
    - name: Install tttool (static build)
      run: |
        wget -q https://github.com/entropia/tip-toi-reveng/releases/download/latest/tttool-Linux
        chmod +x tttool-Linux
        sudo mv tttool-Linux /usr/local/bin/tttool
    
    - name: Install ffmpeg (static build)
      run: |
        wget -q https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
        tar -xf ffmpeg-release-amd64-static.tar.xz
        sudo mv ffmpeg-*-amd64-static/ffmpeg /usr/local/bin/
        sudo mv ffmpeg-*-amd64-static/ffprobe /usr/local/bin/
        rm -rf ffmpeg-*-amd64-static*
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[test]"
    
    - name: Download test audio files (public domain)
      run: |
        mkdir -p tests/fixtures
        # Download small public domain audio files for testing
        # Using a very short silent MP3 file (can be replaced with actual test files)
        wget -q -O tests/fixtures/test1.mp3 "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" || echo "Warning: Could not download test file"
        
    - name: Run E2E tests with pytest
      run: |
        pytest tests/e2e/ -v --tb=short -m "e2e" --html=e2e-report.html --self-contained-html
      continue-on-error: true
    
    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-report
        path: e2e-report.html
      if: always()
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… End-to-end tests completed! Check the artifacts for the detailed report.'
          });
