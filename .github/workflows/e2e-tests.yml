name: End-to-End Tests

# Run E2E tests when there are changes in src/ or tests/e2e/
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running E2E tests'
        required: false
        default: 'Manual E2E test run'
  push:
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - 'tests/e2e/**'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - 'tests/e2e/**'

permissions:
  contents: read

jobs:
  e2e-tests:
    name: End-to-End Tests with Selenium (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for setuptools-scm

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    # Linux-specific setup
    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip

    - name: Install Chrome and ChromeDriver (Linux)
      if: runner.os == 'Linux'
      run: |
        # Install Chrome
        wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y

        # Install ChromeDriver using Chrome for Testing
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d '.' -f 1)
        CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json" | \
          grep -o '"chromedriver".*"linux64".*"url":"[^"]*' | \
          grep -o 'https://[^"]*' | head -1)
        wget -q "$CHROMEDRIVER_URL" -O chromedriver-linux64.zip
        unzip chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        rm -rf chromedriver-linux64*

    - name: Install tttool (Linux)
      if: runner.os == 'Linux'
      run: |
        # Download a specific working version from GitHub releases
        # Using the correct URL pattern: tttool-{version}.zip
        # Note: Linux uses 1.8.1 as it's a stable version with good Linux support
        TTTOOL_VERSION="1.8.1"
        echo "Installing tttool version $TTTOOL_VERSION"

        # Use system temp directory for extraction
        TEMP_DIR=$(mktemp -d)
        cd "$TEMP_DIR"

        wget -q "https://github.com/entropia/tip-toi-reveng/releases/download/${TTTOOL_VERSION}/tttool-${TTTOOL_VERSION}.zip"

        # Extract into temp directory
        unzip -q "tttool-${TTTOOL_VERSION}.zip"

        # Move the binary to /usr/local/bin
        chmod +x tttool
        sudo mv tttool /usr/local/bin/

        # Cleanup - change permissions recursively then remove
        cd "$GITHUB_WORKSPACE"
        chmod -R u+w "$TEMP_DIR" || true
        rm -rf "$TEMP_DIR"

        # Verify installation
        tttool --help || { echo "Error: tttool installation failed"; exit 1; }

    - name: Install ffmpeg (Linux)
      if: runner.os == 'Linux'
      run: .github/scripts/install-ffmpeg-linux.sh

    # macOS-specific setup
    - name: Install ChromeDriver (macOS)
      if: runner.os == 'macOS'
      run: |
        # Install Chrome and ChromeDriver using Homebrew
        brew install --cask google-chrome
        brew install chromedriver

        # Remove quarantine attribute from chromedriver
        xattr -d com.apple.quarantine $(which chromedriver) || true

    - name: Install tttool (macOS)
      if: runner.os == 'macOS'
      run: |
        # Note: macOS requires version 1.11 which includes macOS-specific binaries and .dylib files
        TTTOOL_VERSION="1.11"
        echo "Installing tttool version $TTTOOL_VERSION for macOS"

        # Create temp directory for extraction
        TEMP_DIR=$(mktemp -d)
        cd "$TEMP_DIR"

        # Download and extract tttool
        wget -q "https://github.com/entropia/tip-toi-reveng/releases/download/${TTTOOL_VERSION}/tttool-${TTTOOL_VERSION}.zip"
        unzip -q "tttool-${TTTOOL_VERSION}.zip"
        cd "tttool-${TTTOOL_VERSION}/osx"

        # Move binary to /usr/local/bin
        chmod +x tttool
        sudo mv tttool /usr/local/bin/tttool

        # Copy all .dylib files if they exist
        if ls *.dylib 1> /dev/null 2>&1; then
          sudo mv *.dylib /usr/local/bin/
        fi

        # Cleanup temp directory
        cd "$GITHUB_WORKSPACE"
        chmod -R u+w "$TEMP_DIR" || true
        rm -rf "$TEMP_DIR"

        # Verify installation
        tttool --help || { echo "Error: tttool installation failed"; exit 1; }

    - name: Install ffmpeg (macOS)
      if: runner.os == 'macOS'
      run: |
        # Install ffmpeg using Homebrew
        brew install ffmpeg
        ffmpeg -version | head -n1

    # Windows-specific setup
    - name: Install Chrome and ChromeDriver (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Install Chrome using Chocolatey
        choco install googlechrome -y --ignore-checksums

        # Get Chrome version and download matching ChromeDriver
        $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
        $chromeVersion = (Get-Item $chromePath).VersionInfo.ProductVersion
        $majorVersion = $chromeVersion.Split('.')[0]
        Write-Host "Chrome version: $chromeVersion"

        # Get ChromeDriver download URL for Windows
        $json = Invoke-RestMethod -Uri "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"
        $driverUrl = ($json.channels.Stable.downloads.chromedriver | Where-Object { $_.platform -eq "win64" }).url

        # Download and extract ChromeDriver
        $tempDir = New-Item -ItemType Directory -Path (Join-Path $env:TEMP "chromedriver-temp-$(Get-Random)")
        $zipPath = Join-Path $tempDir "chromedriver.zip"
        Invoke-WebRequest -Uri $driverUrl -OutFile $zipPath
        Expand-Archive -Path $zipPath -DestinationPath $tempDir -Force

        # Move chromedriver to a location in PATH
        $binDir = Join-Path $env:RUNNER_TEMP "bin"
        New-Item -ItemType Directory -Force -Path $binDir | Out-Null
        Copy-Item -Path (Join-Path $tempDir "chromedriver-win64\chromedriver.exe") -Destination (Join-Path $binDir "chromedriver.exe") -Force
        Add-Content -Path $env:GITHUB_PATH -Value $binDir

        # Cleanup
        Remove-Item -Recurse -Force $tempDir

        Write-Host "ChromeDriver installed successfully"

    - name: Install tttool (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Note: Windows uses 1.8.1 as it provides a working Windows executable
        $TTTOOL_VERSION = "1.8.1"
        Write-Host "Installing tttool version $TTTOOL_VERSION for Windows"

        # Create temp directory for extraction
        $tempDir = New-Item -ItemType Directory -Path (Join-Path $env:TEMP "tttool-temp-$(Get-Random)")
        $zipPath = Join-Path $tempDir "tttool.zip"

        # Download tttool
        $url = "https://github.com/entropia/tip-toi-reveng/releases/download/${TTTOOL_VERSION}/tttool-${TTTOOL_VERSION}.zip"
        Invoke-WebRequest -Uri $url -OutFile $zipPath

        # Extract to temp directory
        Expand-Archive -Path $zipPath -DestinationPath $tempDir -Force

        # Find tttool.exe (may be in subdirectory)
        $tttoolExe = Get-ChildItem -Path $tempDir -Filter "tttool.exe" -Recurse | Select-Object -First 1
        if (-not $tttoolExe) {
            Write-Host "Error: tttool.exe not found in archive"
            exit 1
        }

        # Move binary to a location in PATH
        $binDir = Join-Path $env:RUNNER_TEMP "bin"
        New-Item -ItemType Directory -Force -Path $binDir | Out-Null
        Copy-Item -Path $tttoolExe.FullName -Destination (Join-Path $binDir "tttool.exe") -Force
        Add-Content -Path $env:GITHUB_PATH -Value $binDir

        # Cleanup
        Remove-Item -Recurse -Force $tempDir

        # Verify installation
        & "$binDir\tttool.exe" --help
        if ($LASTEXITCODE -ne 0) {
            Write-Host "Error: tttool installation failed"
            exit 1
        }

    - name: Install ffmpeg (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: .github/scripts/install-ffmpeg-windows.ps1

    - name: Install Python dependencies
      shell: bash
      run: |
        uv pip install --system -e ".[test]"

    - name: Prepare test fixtures
      shell: bash
      run: |
        # Bundled test audio file already exists in repo
        ls -lh tests/fixtures/test_audio.mp3

        # Create test cover image if needed
        if [ ! -f tests/fixtures/test_cover.jpg ]; then
          python3 -c "from PIL import Image; img = Image.new('RGB', (100, 100), color='green'); img.save('tests/fixtures/test_cover.jpg')"
        fi

        # Verify files exist
        ls -lh tests/fixtures/

    - name: Run E2E tests with pytest (includes tttool tests)
      shell: bash
      run: |
        pytest tests/e2e/ -v --tb=short --html=e2e-report.html --self-contained-html

    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-report-${{ matrix.os }}
        path: e2e-report.html
      if: always()
