name: End-to-End Tests

# This workflow requires manual approval to run
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running E2E tests'
        required: false
        default: 'Manual E2E test run'
  pull_request:
    types: [labeled]

permissions:
  contents: read
  pull-requests: write  # Needed for posting comments on PRs
    
# Only run when 'run-e2e-tests' label is added or workflow is manually dispatched
jobs:
  check-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      should-run: ${{ steps.check.outputs.result }}
    steps:
      - id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.label.name }}" == "run-e2e-tests" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  e2e-tests:
    name: End-to-End Tests with Selenium
    runs-on: ubuntu-latest
    needs: check-label
    if: needs.check-label.outputs.should-run == 'true'
    
    permissions:
      contents: read
      pull-requests: write  # Needed for posting comments
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for setuptools-scm
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
    
    - name: Install Chrome and ChromeDriver
      run: |
        # Install Chrome
        wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y
        
        # Install ChromeDriver using Chrome for Testing
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d '.' -f 1)
        CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json" | \
          grep -o '"chromedriver".*"linux64".*"url":"[^"]*' | \
          grep -o 'https://[^"]*' | head -1)
        wget -q "$CHROMEDRIVER_URL" -O chromedriver-linux64.zip
        unzip chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        rm -rf chromedriver-linux64*
    
    - name: Install tttool (from releases)
      run: |
        # Download a specific working version from GitHub releases
        # Using the correct URL pattern: tttool-{version}.zip
        TTTOOL_VERSION="1.8.1"
        echo "Installing tttool version $TTTOOL_VERSION"
        wget -q "https://github.com/entropia/tip-toi-reveng/releases/download/${TTTOOL_VERSION}/tttool-${TTTOOL_VERSION}.zip"
        
        # Extract into a subdirectory to avoid conflicts with repo files
        mkdir -p tttool-temp
        unzip -q "tttool-${TTTOOL_VERSION}.zip" -d tttool-temp
        
        # Move the binary to /usr/local/bin
        chmod +x tttool-temp/tttool
        sudo mv tttool-temp/tttool /usr/local/bin/
        
        # Cleanup
        rm -rf tttool-temp "tttool-${TTTOOL_VERSION}.zip"
        
        # Verify installation
        tttool --help || { echo "Error: tttool installation failed"; exit 1; }
    
    - name: Install ffmpeg (static build)
      run: |
        wget -q https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
        tar -xf ffmpeg-release-amd64-static.tar.xz
        sudo mv ffmpeg-*-amd64-static/ffmpeg /usr/local/bin/
        sudo mv ffmpeg-*-amd64-static/ffprobe /usr/local/bin/
        rm -rf ffmpeg-*-amd64-static*
    
    - name: Install Python dependencies
      run: |
        uv pip install --system -e ".[test]"
    
    - name: Download and prepare test audio files
      run: |
        mkdir -p tests/fixtures
        
        # Use bundled minimal test file if available, otherwise download
        if [ ! -f tests/fixtures/minimal_test.mp3 ]; then
          # Download a small public domain MP3 file (fallback)
          wget -q -O tests/fixtures/test_audio.mp3 "https://file-examples.com/storage/fe27a26580566fc2afcde57/2017/11/file_example_MP3_700KB.mp3" || \
          wget -q -O tests/fixtures/test_audio.mp3 "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" || \
          echo "Warning: Could not download test MP3 file, using bundled file"
        else
          cp tests/fixtures/minimal_test.mp3 tests/fixtures/test_audio.mp3
        fi
        
        # Create a small test image
        python3 -c "from PIL import Image; img = Image.new('RGB', (100, 100), color='green'); img.save('tests/fixtures/test_cover.jpg')"
        
        # Verify files exist
        ls -lh tests/fixtures/
        
    - name: Run E2E tests with pytest
      run: |
        pytest tests/e2e/ -v --tb=short -m "e2e" --html=e2e-report.html --self-contained-html
      continue-on-error: true
    
    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-report
        path: e2e-report.html
      if: always()
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… End-to-end tests completed! Check the artifacts for the detailed report.'
          });
