name: End-to-End Tests

# Run E2E tests when there are changes in src/ or tests/e2e/
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running E2E tests'
        required: false
        default: 'Manual E2E test run'
  push:
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - 'tests/e2e/**'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - 'tests/e2e/**'

permissions:
  contents: read

jobs:
  e2e-tests:
    name: End-to-End Tests with Selenium (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        # Always run on Linux, but only run on macOS/Windows for pushes to main/master or manual workflow dispatch
        os: ${{ (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && fromJSON('["ubuntu-latest", "macos-latest", "windows-latest"]') || fromJSON('["ubuntu-latest"]') }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for setuptools-scm

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    # Linux-specific setup
    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip

    - name: Install Chrome and ChromeDriver (Linux)
      if: runner.os == 'Linux'
      run: |
        # Install Chrome
        wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y

        # Install ChromeDriver using Chrome for Testing
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d '.' -f 1)
        CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json" | \
          grep -o '"chromedriver".*"linux64".*"url":"[^"]*' | \
          grep -o 'https://[^"]*' | head -1)
        wget -q "$CHROMEDRIVER_URL" -O chromedriver-linux64.zip
        unzip chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        rm -rf chromedriver-linux64*

    - name: Install tttool (Linux)
      if: runner.os == 'Linux'
      run: .github/scripts/install-tttool-linux.sh

    - name: Install ffmpeg (Linux)
      if: runner.os == 'Linux'
      run: .github/scripts/install-ffmpeg-linux.sh

    # macOS-specific setup
    - name: Install ChromeDriver (macOS)
      if: runner.os == 'macOS'
      run: |
        # Install Chrome and ChromeDriver using Homebrew
        brew install --cask google-chrome
        brew install chromedriver

        # Remove quarantine attribute from chromedriver
        xattr -d com.apple.quarantine $(which chromedriver) || true

    - name: Install tttool (macOS)
      if: runner.os == 'macOS'
      run: .github/scripts/install-tttool-macos.sh

    - name: Install ffmpeg (macOS)
      if: runner.os == 'macOS'
      run: .github/scripts/install-ffmpeg-macos.sh

    # Windows-specific setup
    - name: Install Chrome and ChromeDriver (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Install Chrome using Chocolatey
        choco install googlechrome -y --ignore-checksums

        # Find Chrome installation (check multiple common paths)
        $chromePaths = @(
          "C:\Program Files\Google\Chrome\Application\chrome.exe",
          "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe",
          "$env:LOCALAPPDATA\Google\Chrome\Application\chrome.exe"
        )

        $chromePath = $null
        foreach ($path in $chromePaths) {
          if (Test-Path $path) {
            $chromePath = $path
            break
          }
        }

        if (-not $chromePath) {
          Write-Host "Error: Chrome installation not found"
          exit 1
        }

        # Get Chrome version and download matching ChromeDriver
        $chromeVersion = (Get-Item $chromePath).VersionInfo.ProductVersion
        $majorVersion = $chromeVersion.Split('.')[0]
        Write-Host "Chrome version: $chromeVersion (found at: $chromePath)"

        # Get ChromeDriver download URL for Windows
        $json = Invoke-RestMethod -Uri "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"
        $driverUrl = ($json.channels.Stable.downloads.chromedriver | Where-Object { $_.platform -eq "win64" }).url

        # Download and extract ChromeDriver
        $tempDir = New-Item -ItemType Directory -Path (Join-Path $env:TEMP "chromedriver-temp-$(Get-Random)")
        $zipPath = Join-Path $tempDir "chromedriver.zip"
        Invoke-WebRequest -Uri $driverUrl -OutFile $zipPath
        Expand-Archive -Path $zipPath -DestinationPath $tempDir -Force

        # Move chromedriver to a location in PATH
        $binDir = Join-Path $env:RUNNER_TEMP "bin"
        New-Item -ItemType Directory -Force -Path $binDir | Out-Null
        Copy-Item -Path (Join-Path $tempDir "chromedriver-win64\chromedriver.exe") -Destination (Join-Path $binDir "chromedriver.exe") -Force
        Add-Content -Path $env:GITHUB_PATH -Value $binDir

        # Cleanup
        Remove-Item -Recurse -Force $tempDir

        Write-Host "ChromeDriver installed successfully"

    - name: Install tttool (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: .github/scripts/install-tttool-windows.ps1

    - name: Install ffmpeg (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: .github/scripts/install-ffmpeg-windows.ps1

    - name: Install Python dependencies
      shell: bash
      run: |
        uv pip install --system -e ".[test]"

    - name: Prepare test fixtures
      shell: python
      run: |
        import os
        from pathlib import Path

        # Verify bundled test audio file exists
        test_audio = Path("tests/fixtures/test_audio.mp3")
        if test_audio.exists():
            print(f"Test audio file found: {test_audio} ({test_audio.stat().st_size} bytes)")
        else:
            raise FileNotFoundError(f"Test audio file not found: {test_audio}")

        # Create test cover image if needed
        test_cover = Path("tests/fixtures/test_cover.jpg")
        if not test_cover.exists():
            from PIL import Image
            img = Image.new("RGB", (100, 100), color="green")
            img.save(test_cover)
            print(f"Created test cover image: {test_cover}")
        else:
            print(f"Test cover image found: {test_cover}")

        # Verify all fixtures
        print("\nTest fixtures:")
        for f in Path("tests/fixtures").iterdir():
            if f.is_file():
                print(f"  {f.name} ({f.stat().st_size} bytes)")

    - name: Run E2E tests with pytest (includes tttool tests)
      shell: bash
      run: |
        pytest tests/e2e/ -v --tb=short --html=e2e-report.html --self-contained-html

    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-report-${{ matrix.os }}
        path: e2e-report.html
      if: always()
