name: Build and Release Executables

on:
  release:
    types: [published]
  pull_request:
    paths:
      - 'src/**'
      - 'resources/**'
      - 'ttmp32gme-*.spec'
      - 'pyproject.toml'
      - '.github/workflows/release-executables.yml'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v2.0.0)'
        required: true

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[build]"

      - name: Download tttool for Windows
        run: |
          $TTTOOL_VERSION = "1.8.1"
          Write-Host "Downloading tttool version $TTTOOL_VERSION for Windows"

          # Create lib/win directory if it doesn't exist
          New-Item -ItemType Directory -Force -Path lib/win

          # Download tttool to temp directory
          $tempDir = New-Item -ItemType Directory -Path (Join-Path $env:TEMP "tttool-temp-$(Get-Random)")
          $url = "https://github.com/entropia/tip-toi-reveng/releases/download/${TTTOOL_VERSION}/tttool-${TTTOOL_VERSION}.zip"
          $zipPath = Join-Path $tempDir "tttool.zip"
          Invoke-WebRequest -Uri $url -OutFile $zipPath

          # Extract to temp directory and move binary
          Expand-Archive -Path $zipPath -DestinationPath $tempDir -Force
          Move-Item -Path (Join-Path $tempDir "tttool.exe") -Destination lib/win/tttool.exe -Force

          # Cleanup temp directory
          Remove-Item -Recurse -Force $tempDir

          # Verify
          lib/win/tttool.exe --help

      - name: Download ffmpeg for Windows
        run: |
          Write-Host "Downloading ffmpeg for Windows"

          # Download ffmpeg to temp directory
          $tempDir = New-Item -ItemType Directory -Path (Join-Path $env:TEMP "ffmpeg-temp-$(Get-Random)")
          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          $zipPath = Join-Path $tempDir "ffmpeg.zip"
          Invoke-WebRequest -Uri $url -OutFile $zipPath

          # Extract to temp directory
          Expand-Archive -Path $zipPath -DestinationPath $tempDir -Force

          # Find and move ffmpeg.exe
          $ffmpegDir = Get-ChildItem -Path $tempDir -Directory -Filter "ffmpeg-*" | Select-Object -First 1
          Move-Item -Path (Join-Path $ffmpegDir.FullName "bin/ffmpeg.exe") -Destination lib/win/ffmpeg.exe -Force

          # Cleanup temp directory
          Remove-Item -Recurse -Force $tempDir

          # Verify
          lib/win/ffmpeg.exe -version

      - name: Build Windows executable with PyInstaller
        run: |
          pyinstaller ttmp32gme-windows.spec --clean

      - name: Upload Windows executable
        uses: actions/upload-artifact@v4
        with:
          name: ttmp32gme-windows
          path: dist/ttmp32gme
          retention-days: 30

      - name: Create ZIP archive for release
        if: github.event_name == 'release'
        run: |
          cd dist
          Compress-Archive -Path ttmp32gme -DestinationPath ttmp32gme-windows.zip

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/ttmp32gme-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS Executable
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[build]"

      - name: Download tttool for macOS
        run: |
          TTTOOL_VERSION="1.11"
          echo "Downloading tttool version $TTTOOL_VERSION for macOS"

          # Create lib/mac directory if it doesn't exist
          mkdir -p lib/mac

          # Create temp directory for extraction
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"

          # Download and extract tttool
          wget -q "https://github.com/entropia/tip-toi-reveng/releases/download/${TTTOOL_VERSION}/tttool-${TTTOOL_VERSION}.zip"
          unzip -q "tttool-${TTTOOL_VERSION}.zip"
          cd osx

          # List extracted files for debugging
          echo "Extracted files:"
          ls -la

          # Check file type
          echo "File type of tttool:"
          file tttool || echo "file command failed"

          # Move binary and dynamic libraries to lib/mac
          chmod +x tttool
          mv tttool "$GITHUB_WORKSPACE/lib/mac/tttool"

          # Copy all .dylib files if they exist
          if ls *.dylib 1> /dev/null 2>&1; then
            mv *.dylib "$GITHUB_WORKSPACE/lib/mac/"
          fi

          # Remove quarantine attribute to allow execution on macOS
          xattr -d com.apple.quarantine "$GITHUB_WORKSPACE/lib/mac/tttool" 2>/dev/null || true

          # Also remove quarantine from dylibs if present
          for dylib in "$GITHUB_WORKSPACE/lib/mac"/*.dylib; do
            [ -f "$dylib" ] && sudo xattr -d com.apple.quarantine "$dylib" 2>/dev/null || true
          done

          # Cleanup temp directory - change permissions first to ensure deletion succeeds
          cd "$GITHUB_WORKSPACE"
          chmod -R u+w "$TEMP_DIR" || true
          rm -rf "$TEMP_DIR"

          # Verify - check architecture and try to run
          echo "tttool binary info:"
          file lib/mac/tttool
          echo "Architecture:"
          lipo -info lib/mac/tttool || echo "lipo command not available or failed"
          echo "Attempting to run tttool --help:"
          lib/mac/tttool --help || {
            echo "Failed to execute tttool"
            echo "Exit code: $?"
            echo "Checking otool dependencies:"
            otool -L lib/mac/tttool || echo "otool failed"
            exit 1
          }

      - name: Download ffmpeg for macOS
        run: |
          echo "Downloading ffmpeg for macOS"

          # Create temp directory for extraction
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"

          # Download ffmpeg static build for macOS
          wget -q "https://evermeet.cx/ffmpeg/getrelease/ffmpeg/zip" -O ffmpeg.zip
          unzip -q ffmpeg.zip

          # Move binary to lib/mac
          chmod +x ffmpeg
          mv ffmpeg "$GITHUB_WORKSPACE/lib/mac/ffmpeg"

          # Remove quarantine attribute to allow execution on macOS
          xattr -d com.apple.quarantine "$GITHUB_WORKSPACE/lib/mac/ffmpeg" 2>/dev/null || true

          # Cleanup temp directory - change permissions first to ensure deletion succeeds
          cd "$GITHUB_WORKSPACE"
          chmod -R u+w "$TEMP_DIR" || true
          rm -rf "$TEMP_DIR"

          # Verify
          lib/mac/ffmpeg -version

      - name: Build macOS executable with PyInstaller
        run: |
          pyinstaller ttmp32gme-macos.spec --clean

      - name: Prepare macOS artifact
        run: |
          # Create a clean artifact directory with the .app bundle
          mkdir -p artifact-macos
          cp -R dist/ttmp32gme.app artifact-macos/

      - name: Upload macOS executable
        uses: actions/upload-artifact@v4
        with:
          name: ttmp32gme-macos
          path: artifact-macos/
          retention-days: 30

      - name: Create ZIP archive for release
        if: github.event_name == 'release'
        run: |
          cd dist
          # For now, create a ZIP. Later we can create a proper DMG
          zip -r ttmp32gme-macos.zip ttmp32gme.app

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/ttmp32gme-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
